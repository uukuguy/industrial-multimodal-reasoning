# å·¥ä¸šæŠ€æœ¯æ–‡æ¡£å¤šæ¨¡æ€æ¨ç†é—®ç­”ç³»ç»Ÿ

[**CCKS2025-å·¥ä¸šæŠ€æœ¯æ–‡æ¡£å¤šæ¨¡æ€æ¨ç†é—®ç­”è¯„æµ‹**](https://tianchi.aliyun.com/competition/entrance/532357/information)

2025.05.01 - 2025.08.01

## é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®ä¸ºCCKS2025å·¥ä¸šæŠ€æœ¯æ–‡æ¡£å¤šæ¨¡æ€æ¨ç†é—®ç­”è¯„æµ‹ä»»åŠ¡çš„è§£å†³æ–¹æ¡ˆã€‚ç³»ç»Ÿèƒ½å¤Ÿå¤„ç†å·¥ä¸šæŠ€æœ¯æ–‡æ¡£ä¸­çš„æ–‡æœ¬ã€å›¾åƒå’Œç‰ˆé¢ä¿¡æ¯ï¼Œè¿›è¡Œå¤šæ¨¡æ€æ¨ç†ï¼Œé’ˆå¯¹åˆèµ›çš„é€‰æ‹©é¢˜å’Œå¤èµ›çš„å¼€æ”¾é¢˜è¿›è¡Œå›ç­”ã€‚

ç³»ç»Ÿè§£å†³äº†å·¥ä¸šæŠ€æœ¯æ–‡æ¡£å¤šæ¨¡æ€æ¨ç†é¢ä¸´çš„ä¸‰å¤§æŒ‘æˆ˜ï¼š
1. å›¾ç‰‡å‹åŸå§‹æ–‡æ¡£è¯†åˆ«ï¼šå¤„ç†ä¸å¯ç¼–è¾‘çš„PDFæ–‡æ¡£ï¼ŒåŒ…æ‹¬ä½åˆ†è¾¨ç‡ã€å¤šæ ·æ ¼å¼å’Œå¤æ‚å†…å®¹
2. å¤šæ¨¡æ€ä¿¡æ¯èåˆï¼šåŒæ—¶è§£ææ–‡æœ¬æè¿°å’ŒæŠ€æœ¯å›¾çº¸ç­‰å¤šæ¨¡æ€æ•°æ®
3. å¤æ‚åŒ–é¢†åŸŸçŸ¥è¯†æ¨ç†ï¼šé€šè¿‡å›¾çº¸ç»“æ„è§£æã€æ¨¡å—åŠŸèƒ½ç†è§£æˆ–æœºæ¢°åŸç†æ¨å¯¼è·å¾—ç­”æ¡ˆ

## ç³»ç»Ÿæ¶æ„

ç³»ç»Ÿé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼ŒåŒ…å«å››ä¸ªæ ¸å¿ƒæ¨¡å—å’Œå¤šä¸ªè¾…åŠ©ç»„ä»¶ï¼š

![ç³»ç»Ÿæ¶æ„](docs/images/system_architecture.png)

### æ ¸å¿ƒæ¨¡å—

1. **æ–‡æ¡£é¢„å¤„ç†æ¨¡å—**ï¼šå°†PDFæ–‡æ¡£è½¬æ¢ä¸ºç»“æ„åŒ–çš„æ–‡æœ¬ã€å›¾åƒå’Œç‰ˆé¢ä¿¡æ¯
2. **å¤šæ¨¡æ€ç¼–ç æ¨¡å—**ï¼šå°†ä¸åŒæ¨¡æ€çš„ä¿¡æ¯ç¼–ç ä¸ºåµŒå…¥å‘é‡
3. **å¤šæ¨¡æ€èåˆæ¨¡å—**ï¼šèåˆä¸åŒæ¨¡æ€çš„ä¿¡æ¯ï¼Œå½¢æˆç»Ÿä¸€çš„æ–‡æ¡£è¡¨ç¤º
4. **æ¨ç†ä¸é—®ç­”æ¨¡å—**ï¼šæ ¹æ®æ–‡æ¡£è¡¨ç¤ºå’Œé—®é¢˜ç”Ÿæˆç­”æ¡ˆ

## è®­ç»ƒä¼˜åŒ–ç­–ç•¥

é¢å¯¹å·¥ä¸šæŠ€æœ¯æ–‡æ¡£å¤šæ¨¡æ€æ¨ç†çš„æŒ‘æˆ˜ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€å¥—é’ˆå¯¹æ€§çš„è®­ç»ƒä¼˜åŒ–ç­–ç•¥ï¼Œå…‹æœäº†æ•°æ®é‡æœ‰é™ã€ä¸å¹³è¡¡ç­‰é—®é¢˜ï¼š

![è®­ç»ƒä¼˜åŒ–ç­–ç•¥](docs/images/training_optimization.png)

### ä¼˜åŒ–è¦ç‚¹

1. **æ•°æ®å¢å¼ºä¸å¹³è¡¡**ï¼š
   - å®ç°æ™ºèƒ½æ•°æ®å¢å¼ºæ‰©å……è®­ç»ƒé›†(é—®é¢˜æ”¹å†™ã€é€‰é¡¹å¢å¼ºã€å›°éš¾è´Ÿæ ·æœ¬ç”Ÿæˆ)
   - é’ˆå¯¹ä½é¢‘é—®é¢˜ç±»å‹(æŠ€æœ¯å‚æ•°ã€æ“ä½œæ­¥éª¤)çš„é‡ç‚¹å¢å¼º
   - å°†300æ ·æœ¬æ‰©å……è‡³450-500ä¸ªæœ‰æ•ˆæ ·æœ¬

2. **å‚æ•°é«˜æ•ˆå¾®è°ƒ(PEFT)**ï¼š
   - åº”ç”¨LoRAã€Prefix-Tuningç­‰æŠ€æœ¯ï¼Œå‡å°‘99%è®­ç»ƒå‚æ•°
   - è‡ªåŠ¨é€‰æ‹©é€‚åˆæ•°æ®è§„æ¨¡çš„æœ€ä½³PEFTæŠ€æœ¯
   - é™ä½è¿‡æ‹Ÿåˆé£é™©ï¼Œæå‡æ³›åŒ–èƒ½åŠ›

3. **æ”¹è¿›çš„æ–‡æ¡£å¤„ç†**ï¼š
   - é›†æˆPaddleOCRå¤„ç†å›¾åƒå‹PDF
   - ä¼˜åŒ–æ–‡æœ¬ã€å›¾åƒã€ç‰ˆé¢ç‰¹å¾æå–
   - å¢å¼ºå¯¹å¤æ‚å›¾è¡¨çš„ç†è§£èƒ½åŠ›

4. **é«˜æ•ˆè®­ç»ƒæ¡†æ¶**ï¼š
   - åˆ†å¸ƒå¼è®­ç»ƒä¸æ··åˆç²¾åº¦æ”¯æŒ
   - ä¸Weights & Biasesé›†æˆçš„å®éªŒè¿½è¸ª
   - è‡ªåŠ¨åŒ–çš„æœ€ä½³åŒ–é…ç½®é€‰æ‹©

### ä¼˜åŒ–æŸå¤±å‡½æ•°

æ–°å¢äº†ä¸“é—¨é’ˆå¯¹å·¥ä¸šæŠ€æœ¯æ–‡æ¡£å¤šæ¨¡æ€ç†è§£çš„ä¼˜åŒ–æŸå¤±å‡½æ•°ï¼š

```python
# ä¼˜åŒ–çš„æŸå¤±å‡½æ•°é…ç½®ç¤ºä¾‹
python scripts/train_model.py \
    --train_questions data/raw_data/train/questions.jsonl \
    --documents data/raw_data/train/documents \
    --use_optimized_loss \
    --output_dir outputs/model_optimized_loss
```

ä¸»è¦ä¼˜åŒ–åŒ…æ‹¬ï¼š

- **æ ‡ç­¾å¹³æ»‘ä¸ç±»åˆ«åŠ æƒ**ï¼šç¼“è§£é€‰æ‹©é¢˜è¿‡æ‹Ÿåˆå’Œç±»åˆ«ä¸å¹³è¡¡é—®é¢˜
- **æŠ€æœ¯å‚æ•°è¯†åˆ«å¼ºåŒ–**ï¼šç‰¹æ®Šå¤„ç†æ•°å€¼å‹ç­”æ¡ˆï¼Œç²¾ç¡®è¯„ä¼°å‚æ•°è¯†åˆ«èƒ½åŠ›
- **å¤šä»»åŠ¡å­¦ä¹ æ”¯æŒ**ï¼šæ•´åˆé‡æ„æŸå¤±å’Œè·¨æ¨¡æ€å¯¹é½æŸå¤±
- **ç½®ä¿¡åº¦æ ¡å‡†**ï¼šè€ƒè™‘ä¸ç¡®å®šæ€§ä¼°è®¡ï¼Œå¢å¼ºå¯é æ€§

### é¢„æœŸæ•ˆæœ

- åˆèµ›ä»»åŠ¡å‡†ç¡®ç‡æå‡15-20%
- å¤èµ›å¼€æ”¾é¢˜è¡¨ç°æ˜¾è‘—å¢å¼º
- å¯¹ä½é¢‘é—®é¢˜ç±»å‹çš„å¤„ç†èƒ½åŠ›å¤§å¹…æå‡
- è®­ç»ƒæ•ˆç‡å’Œèµ„æºåˆ©ç”¨ç‡æ˜æ˜¾ä¼˜åŒ–
- æŠ€æœ¯å‚æ•°å’Œæ•°å€¼è¯†åˆ«å‡†ç¡®åº¦æé«˜25-30%

### æ•°æ®æµ

```
PDFæ–‡æ¡£ â†’ æ–‡æ¡£é¢„å¤„ç† â†’ å¤šæ¨¡æ€ç¼–ç  â†’ å¤šæ¨¡æ€èåˆ â†’ æ¨ç†ä¸é—®ç­” â†’ ç­”æ¡ˆ
```

## æ¨¡å‹è®¾è®¡ä¸å®ç°

### 1. å¢å¼ºå‹å¤šæ¨¡æ€æ¶æ„

ç³»ç»Ÿé‡‡ç”¨å¢å¼ºå‹å¤šæ¨¡æ€æ¶æ„ï¼Œé€šè¿‡ä»¥ä¸‹æŠ€æœ¯å®ç°æ¨¡æ€é—´çš„æ·±åº¦äº¤äº’å’Œä¿¡æ¯æ•´åˆï¼š

#### 1.1 å±‚æ¬¡åŒ–èåˆæ¶æ„

é‡‡ç”¨ä¸‰çº§èåˆç­–ç•¥ï¼Œå®ç°å¤šæ¨¡æ€ä¿¡æ¯çš„é€æ­¥æ•´åˆï¼š
- **ä½çº§èåˆ**ï¼šæ•è·åŸºæœ¬çš„æ¨¡æ€å¯¹é½ï¼Œä¸»è¦å¤„ç†æ–‡æœ¬å’Œå›¾åƒé—´çš„åˆæ­¥å…³è”
- **ä¸­çº§èåˆ**ï¼šæ•´åˆè¯­ä¹‰å’Œç©ºé—´å…³ç³»ï¼Œå¼•å…¥ç‰ˆé¢ä¿¡æ¯ï¼Œå»ºç«‹æ›´æ·±å±‚æ¬¡çš„ç†è§£
- **é«˜çº§èåˆ**ï¼šå½¢æˆç»Ÿä¸€çš„å¤šæ¨¡æ€è¡¨ç¤ºï¼Œç”Ÿæˆæœ€ç»ˆç”¨äºæ¨ç†çš„æ–‡æ¡£è¡¨ç¤º

#### 1.2 è·¨æ¨¡æ€æ³¨æ„åŠ›æœºåˆ¶

ä½¿ç”¨å¢å¼ºå‹è·¨æ¨¡æ€æ³¨æ„åŠ›ï¼Œå®ç°ä¸åŒæ¨¡æ€é—´çš„ä¿¡æ¯äº¤äº’ï¼š
- **è‡ªé€‚åº”æ³¨æ„åŠ›é—¨æ§**ï¼šæ ¹æ®æ¨¡æ€å†…å®¹åŠ¨æ€è°ƒæ•´ä¿¡æ¯æµåŠ¨
- **å¤šå¤´æ³¨æ„åŠ›**ï¼šä»ä¸åŒè§’åº¦æ•è·æ¨¡æ€é—´å…³ç³»
- **æ¨¡æ€å¯¹äº¤äº’**ï¼šè§†è§‰-æ–‡æœ¬ã€è§†è§‰-ç‰ˆé¢ã€æ–‡æœ¬-ç‰ˆé¢ä¹‹é—´çš„åŒå‘äº¤äº’

#### 1.3 ç¼ºå¤±æ¨¡æ€å¤„ç†

é€šè¿‡æ¨¡æ€é‡æ„å’Œä¼˜é›…é™çº§æœºåˆ¶ï¼Œå¤„ç†ç¼ºå¤±æ¨¡æ€æƒ…å†µï¼š
- **æ¨¡æ€é‡æ„**ï¼šä»å¯ç”¨æ¨¡æ€é‡å»ºç¼ºå¤±æ¨¡æ€
- **ä¼˜é›…é™çº§**ï¼šæ ¹æ®å¯ç”¨æ¨¡æ€è‡ªåŠ¨è°ƒæ•´é¢„æµ‹ç­–ç•¥
- **æ¨¡æ€å­˜åœ¨æŒ‡ç¤ºå™¨**ï¼šä¸ºæ¯ä¸ªæ¨¡æ€ç»´æŠ¤å­˜åœ¨æŒ‡ç¤ºå™¨ï¼Œç¡®ä¿æ¨¡å‹æ¶æ„ä¸€è‡´æ€§

### 2. ç»„ä»¶è¯¦ç»†è¯´æ˜

#### 2.1 æ–‡æ¡£é¢„å¤„ç† (`model/pdf_processor.py`)

##### è®¾è®¡ä¸å®ç°æ€è·¯

æ–‡æ¡£é¢„å¤„ç†æ¨¡å—è´Ÿè´£å°†åŸå§‹PDFæ–‡æ¡£è½¬æ¢ä¸ºç»“æ„åŒ–çš„å¤šæ¨¡æ€ä¿¡æ¯ï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿçš„åŸºç¡€ã€‚å…¶æ ¸å¿ƒè®¾è®¡ç†å¿µåŒ…æ‹¬ï¼š

1. **çµæ´»æ€§**ï¼šåŒæ—¶æ”¯æŒé«˜çº§ç‰ˆé¢åˆ†æå’ŒåŸºæœ¬æ–‡æœ¬æå–æ¨¡å¼ï¼Œæ ¹æ®å¯ç”¨ä¾èµ–è‡ªåŠ¨è°ƒæ•´
2. **å¥å£®æ€§**ï¼šå¯¹å¼‚å¸¸æƒ…å†µè¿›è¡Œä¼˜é›…å¤„ç†ï¼Œå•é¡µé”™è¯¯ä¸å½±å“æ•´ä½“å¤„ç†æµç¨‹
3. **æ¨¡å—åŒ–**ï¼šæ¸…æ™°çš„å¤„ç†æ­¥éª¤å’Œæ•°æ®ç»“æ„ï¼Œä¾¿äºä¸ç³»ç»Ÿå…¶ä»–éƒ¨åˆ†äº¤äº’
4. **å¯æ‰©å±•æ€§**ï¼šè‰¯å¥½çš„æ¥å£è®¾è®¡ï¼Œä¾¿äºæœªæ¥æ”¯æŒæ›´å¤šæ–‡æ¡£ç±»å‹å’Œåˆ†æç­–ç•¥

å¤„ç†æµç¨‹ï¼š

1. **PDFé¡µé¢æ¸²æŸ“**ï¼š
   - ä½¿ç”¨PyMuPDF (fitz) å°†PDFé¡µé¢æ¸²æŸ“ä¸ºé«˜åˆ†è¾¨ç‡å›¾åƒ
   - ä¿å­˜æ¯é¡µå›¾åƒä»¥ä¾›åç»­åˆ†æå’Œå¯è§†åŒ–

2. **ç‰ˆé¢åˆ†æ**ï¼š
   - ä½¿ç”¨LayoutParseråº“çš„é¢„è®­ç»ƒDetectron2æ¨¡å‹è¿›è¡Œç‰ˆé¢åˆ†å‰²
   - è¯†åˆ«æ–‡æœ¬å—ã€æ ‡é¢˜ã€åˆ—è¡¨ã€è¡¨æ ¼å’Œå›¾è¡¨ç­‰å…ƒç´ 
   - æå–æ¯ä¸ªå…ƒç´ çš„ç±»å‹å’Œåæ ‡ä¿¡æ¯

3. **OCRæ–‡æœ¬æå–**ï¼š
   - ä½¿ç”¨PaddleOCRå¯¹æ–‡æœ¬åŒºåŸŸè¿›è¡Œè¯†åˆ«
   - æ”¯æŒä¸­æ–‡å’Œè‹±æ–‡æ–‡æœ¬è¯†åˆ«
   - åˆå¹¶åŒä¸€åŒºåŸŸçš„æ–‡æœ¬è¡Œ

4. **å›¾åƒæå–**ï¼š
   - æ ¹æ®ç‰ˆé¢åˆ†æç»“æœæå–å›¾è¡¨å’Œè¡¨æ ¼åŒºåŸŸ
   - ä¿å­˜ä¸ºç‹¬ç«‹çš„å›¾åƒæ–‡ä»¶ä»¥ä¾›è§†è§‰æ¨¡å‹åˆ†æ

5. **ç»“æ„åŒ–è¡¨ç¤º**ï¼š
   - å°†æ‰€æœ‰æå–çš„ä¿¡æ¯æ•´åˆä¸ºç»Ÿä¸€çš„æ•°æ®ç»“æ„
   - æ¯é¡µç”ŸæˆåŒ…å«é¡µç ã€å›¾åƒè·¯å¾„ã€ç‰ˆé¢ä¿¡æ¯å’Œæ–‡æœ¬å†…å®¹çš„ç»“æ„åŒ–å­—å…¸
   - ä¿ç•™åŸå§‹åæ ‡ä¿¡æ¯ä»¥æ”¯æŒç©ºé—´å…³ç³»åˆ†æ

##### é”™è¯¯å¤„ç†æœºåˆ¶

1. **ä¾èµ–ç®¡ç†**ï¼š
   - æ¡ä»¶å¯¼å…¥å¸ƒå±€åˆ†æå’ŒOCRä¾èµ–
   - åœ¨ä¾èµ–ä¸å¯ç”¨æ—¶è‡ªåŠ¨é™çº§åˆ°åŸºæœ¬å¤„ç†æ¨¡å¼

2. **å¼‚å¸¸æ•è·**ï¼š
   - é¡µé¢çº§é”™è¯¯éš”ç¦»ï¼Œå•é¡µé”™è¯¯ä¸å½±å“æ•´ä¸ªæ–‡æ¡£å¤„ç†
   - è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼Œä¾¿äºé—®é¢˜è¯Šæ–­

3. **æ•°æ®éªŒè¯**ï¼š
   - åæ ‡æœ‰æ•ˆæ€§æ£€æŸ¥ï¼Œé˜²æ­¢å›¾åƒå¤„ç†è¶Šç•Œ
   - æ–‡æœ¬å’Œå›¾åƒå†…å®¹éªŒè¯ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§

##### ä½¿ç”¨æ–¹æ³•

```python
from model.pdf_processor import process_pdf

# å¤„ç†å•ä¸ªPDFæ–‡ä»¶
pdf_path = "path/to/document.pdf"
output_dir = "path/to/output"
processed_data = process_pdf(pdf_path, output_dir)

# å¤„ç†ç»“æœæ˜¯ä¸€ä¸ªåŒ…å«æ¯é¡µä¿¡æ¯çš„åˆ—è¡¨
if processed_data:
    for page in processed_data:
        # è®¿é—®é¡µé¢ä¿¡æ¯
        page_num = page["page_num"]
        image_path = page["image_path"]
        layout = page["layout"]
        text_blocks = page["text_blocks"]
        
        # å¤„ç†æ–‡æœ¬å†…å®¹
        for block in text_blocks:
            block_type = block["type"]  # Text, Title, List
            text = block["text"]
            coordinates = block["coordinates"]
            
        # å¤„ç†å›¾åƒå†…å®¹
        for block in layout:
            if block["type"] in ["Figure", "Table"]:
                segment_path = block["image_segment_path"]
                # å¤„ç†å›¾è¡¨æˆ–è¡¨æ ¼å›¾åƒ
```

##### è¾“å‡ºæ•°æ®ç»“æ„

```python
# æ¯é¡µçš„å¤„ç†ç»“æœç»“æ„
{
    "page_num": 1,                      # é¡µç 
    "image_path": "path/to/page_1.png",  # é¡µé¢å›¾åƒè·¯å¾„
    "layout": [                          # ç‰ˆé¢å…ƒç´ åˆ—è¡¨
        {
            "type": "Text",              # å…ƒç´ ç±»å‹ (Text, Title, List, Table, Figure)
            "coordinates": (x1, y1, x2, y2),  # å…ƒç´ åæ ‡ (å·¦ä¸Šè§’å’Œå³ä¸‹è§’)
            "text": "æ–‡æœ¬å†…å®¹...",        # æ–‡æœ¬å†…å®¹ (ä»…æ–‡æœ¬ç±»å‹æœ‰)
            "image_segment_path": None    # å›¾åƒç‰‡æ®µè·¯å¾„ (ä»…å›¾è¡¨/è¡¨æ ¼æœ‰)
        },
        # ...æ›´å¤šç‰ˆé¢å…ƒç´ 
    ],
    "text_blocks": [...]                 # æ–‡æœ¬å—åˆ—è¡¨ (layoutä¸­çš„æ–‡æœ¬å…ƒç´ å­é›†)
}
```

#### 2.2 å¤šæ¨¡æ€ç¼–ç  (`model/multimodal_encoder.py`)

ç¼–ç å„æ¨¡æ€æ•°æ®ä¸ºåµŒå…¥å‘é‡ï¼š
- **æ–‡æœ¬ç¼–ç **ï¼šä½¿ç”¨é¢„è®­ç»ƒä¸­æ–‡è¯­è¨€æ¨¡å‹ (BERT) ç¼–ç æ–‡æœ¬å†…å®¹
- **å›¾åƒç¼–ç **ï¼šä½¿ç”¨é¢„è®­ç»ƒè§†è§‰æ¨¡å‹ (ViT) ç¼–ç å›¾åƒå†…å®¹
- **ç‰ˆé¢ç¼–ç **ï¼šç¼–ç æ–‡æ¡£çš„ç‰ˆé¢ç»“æ„å’Œç©ºé—´å…³ç³»

ä¼˜åŒ–ç‰¹æ€§ï¼š
- æ¨¡å‹ç¼“å­˜æœºåˆ¶ï¼šé¿å…é‡å¤åŠ è½½æ¨¡å‹
- æ‰¹å¤„ç†æ”¯æŒï¼šæé«˜å¤„ç†æ•ˆç‡
- è®¾å¤‡ç®¡ç†ï¼šè‡ªåŠ¨ä½¿ç”¨CPU/GPU
- é”™è¯¯æ¢å¤æœºåˆ¶ï¼šæé«˜ç³»ç»Ÿç¨³å®šæ€§

#### 2.3 è·¨æ¨¡æ€æ³¨æ„åŠ› (`model/cross_modal_attention.py`)

å®ç°æ¨¡æ€é—´çš„æ·±åº¦ä¿¡æ¯äº¤äº’ï¼š
- **CrossModalAttention**ï¼šå•ä¸ªè·¨æ¨¡æ€æ³¨æ„åŠ›æ¨¡å—
- **MultiModalAttentionHub**ï¼šé›†æˆå¤šä¸ªè·¨æ¨¡æ€æ³¨æ„åŠ›æ¨¡å—ï¼Œåè°ƒä¸åŒæ¨¡æ€å¯¹ä¹‹é—´çš„äº¤äº’

#### 2.4 å¤šæ¨¡æ€èåˆ (`model/multimodal_fusion.py`)

èåˆä¸åŒæ¨¡æ€çš„ä¿¡æ¯ï¼š
- **MultimodalFusion**ï¼šåŸºç¡€èåˆæ¨¡å—
- **HierarchicalMultimodalFusion**ï¼šå±‚æ¬¡åŒ–èåˆæ¨¡å—ï¼Œå®ç°ä½çº§ã€ä¸­çº§å’Œé«˜çº§ç‰¹å¾çš„é€æ­¥èåˆ

#### 2.5 æ¨¡æ€é‡æ„ (`model/modality_reconstructor.py`)

ä»å¯ç”¨æ¨¡æ€é‡å»ºç¼ºå¤±æ¨¡æ€ï¼š
- **è§†è§‰é‡æ„**ï¼šä»æ–‡æœ¬å’Œç‰ˆé¢é‡æ„è§†è§‰ç‰¹å¾
- **æ–‡æœ¬é‡æ„**ï¼šä»è§†è§‰å’Œç‰ˆé¢é‡æ„æ–‡æœ¬ç‰¹å¾
- **ç‰ˆé¢é‡æ„**ï¼šä»è§†è§‰å’Œæ–‡æœ¬é‡æ„ç‰ˆé¢ç‰¹å¾

#### 2.6 ä¸ç¡®å®šæ€§ä¼°è®¡ (`model/uncertainty_estimator.py`)

æä¾›é¢„æµ‹ç»“æœçš„ç½®ä¿¡åº¦è¯„ä¼°ï¼š
- **å¤šå±‚æ¬¡ä¸ç¡®å®šæ€§**ï¼šæ•°æ®ä¸ç¡®å®šæ€§ã€æ¨¡å‹ä¸ç¡®å®šæ€§ã€é¢„æµ‹ä¸ç¡®å®šæ€§
- **æ ¡å‡†ç½®ä¿¡åº¦**ï¼šä½¿ç”¨æ¸©åº¦ç¼©æ”¾ç­‰æŠ€æœ¯æ ¡å‡†ç½®ä¿¡åº¦
- **é£é™©è¯„ä¼°**ï¼šè¯†åˆ«éœ€è¦äººå·¥å®¡æ ¸çš„æ¡ˆä¾‹

#### 2.7 æ¨ç†ä¸é—®ç­” (`model/qa_module.py`)

æ ¹æ®èåˆçš„æ–‡æ¡£è¡¨ç¤ºç”Ÿæˆç­”æ¡ˆï¼š
- **ReasoningQAModule**ï¼šåŸºç¡€é—®ç­”æ¨¡å—
- **EnhancedReasoningQAModule**ï¼šå¢å¼ºå‹é—®ç­”æ¨¡å—ï¼Œæ·»åŠ è‡ªæ ¡æ­£æœºåˆ¶å’Œé¢†åŸŸçŸ¥è¯†çº¦æŸ

#### 2.8 å¢å¼ºå‹å¤šæ¨¡æ€æ¨¡å‹ (`model/enhanced_model.py`)

æ•´åˆæ‰€æœ‰ç»„ä»¶ï¼Œæä¾›ç»Ÿä¸€æ¥å£ï¼š
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ¸…æ™°çš„æ¥å£å’Œè´£ä»»åˆ’åˆ†
- **é…ç½®é©±åŠ¨**ï¼šæ”¯æŒçµæ´»é…ç½®
- **çŠ¶æ€ç®¡ç†**ï¼šå®Œæ•´çš„ä¿å­˜å’ŒåŠ è½½æœºåˆ¶

#### 2.9 é…ç½®ç³»ç»Ÿ (`model/config.py`)

å¢å¼ºå‹YAMLé…ç½®ç³»ç»Ÿï¼š
- **é…ç½®ç»§æ‰¿**ï¼šåŸºäºé»˜è®¤é…ç½®è¿›è¡Œè¦†ç›–
- **é…ç½®éªŒè¯**ï¼šè‡ªåŠ¨æ£€æŸ¥é…ç½®æœ‰æ•ˆæ€§
- **è¿è¡Œæ—¶é…ç½®**ï¼šæ”¯æŒå‘½ä»¤è¡Œå‚æ•°è¦†ç›–
- **å»¶è¿ŸåŠ è½½**ï¼šæŒ‰éœ€åŠ è½½é…ç½®ï¼Œæé«˜æ€§èƒ½
- **YAMLæ”¯æŒ**ï¼šä½¿ç”¨äººç±»å¯è¯»çš„YAMLæ ¼å¼
- **é…ç½®æ–‡ä»¶åˆ†ç¦»**ï¼šé»˜è®¤é…ç½®ä¸è®­ç»ƒé…ç½®åˆ†ç¦»
- **éšæœºç§å­ç®¡ç†**ï¼šç¡®ä¿å®éªŒå¯å¤ç°æ€§
- **è‡ªåŠ¨ç›®å½•åˆ›å»º**ï¼šç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨

é…ç½®ç³»ç»Ÿæ”¯æŒå¤šç§é…ç½®æ–¹å¼ï¼š
- **é»˜è®¤é…ç½®**ï¼š`config/default_config.yaml`åŒ…å«æ‰€æœ‰å¯é…ç½®å‚æ•°
- **è®­ç»ƒé…ç½®**ï¼š`config/training_config.yaml`é’ˆå¯¹ç‰¹å®šè®­ç»ƒåœºæ™¯ä¼˜åŒ–
- **å‘½ä»¤è¡Œè¦†ç›–**ï¼šå‘½ä»¤è¡Œå‚æ•°å¯è¦†ç›–é…ç½®æ–‡ä»¶ä¸­çš„è®¾ç½®
- **é…ç½®åˆå¹¶**ï¼šå¤šä¸ªé…ç½®æºå¯ä»¥é€’å½’åˆå¹¶

è¯¦ç»†è¯´æ˜è¯·å‚è€ƒ[YAMLé…ç½®ç³»ç»Ÿä½¿ç”¨æŒ‡å—](docs/yaml_configuration_guide.md)ã€‚

### 3. æ¨¡å‹è®­ç»ƒ

å¢å¼ºå‹å¤šæ¨¡æ€æ¨¡å‹æ”¯æŒå®Œæ•´çš„è®­ç»ƒæµç¨‹ï¼ŒåŒ…æ‹¬é¢„å¤„ç†ã€è®­ç»ƒå’Œè¯„ä¼°ã€‚

#### 3.1 è®­ç»ƒæ•°æ®å‡†å¤‡

è®­ç»ƒæ•°æ®éœ€è¦ä»¥JSONLæ ¼å¼æä¾›ï¼Œå†…å®¹åŒ…æ‹¬é—®é¢˜ã€æ–‡æ¡£å¼•ç”¨å’Œç­”æ¡ˆï¼š

åˆèµ›æ•°æ®æ ¼å¼ï¼ˆå•é€‰é¢˜ï¼‰ï¼š
```json
{
  "id": "question_123",
  "question": "æ ¹æ®æ–‡æœ¬ä¿¡æ¯ï¼Œä»¥ä¸‹å“ªä¸ªæè¿°ç¬¦åˆè¯¥é™ç”µé™¤å°˜å™¨çš„ç‰¹å¾ï¼Ÿ",
  "document": "CN100342976C.pdf",
  "options": ["A. ç‰¹å¾1", "B. ç‰¹å¾2", "C. ç‰¹å¾3", "D. ç‰¹å¾4"],
  "answer": "C"
}
```

å¤èµ›æ•°æ®æ ¼å¼ï¼ˆå¼€æ”¾é¢˜ï¼‰ï¼š
```json
{
  "id": "question_456",
  "question": "åœ¨æ–‡ä»¶ä¸­ç¬¬7é¡µçš„å›¾ç‰‡ä¸­ï¼Œéƒ¨ä»¶4ç›¸å¯¹äºéƒ¨ä»¶5åœ¨å›¾ç‰‡ä¸­çš„ä½ç½®å…³ç³»æ˜¯ï¼Ÿ",
  "document": "CN100342976C.pdf",
  "answer": "éƒ¨ä»¶4ä½äºéƒ¨ä»¶5çš„å·¦ä¾§"
}
```

#### 3.2 è®­ç»ƒæ¨¡å‹

ä½¿ç”¨`scripts/train_model.py`è„šæœ¬è®­ç»ƒæ¨¡å‹ï¼Œç°åœ¨åŸºäºtransformersåº“çš„Trainerå®ç°ï¼Œæä¾›æ›´ä¸°å¯Œçš„åŠŸèƒ½ï¼š

```bash
# åŸºæœ¬è®­ç»ƒå‘½ä»¤
python scripts/train_model.py \
    --train_questions data/raw_data/train/questions.jsonl \
    --valid_questions data/raw_data/valid/questions.jsonl \
    --documents data/raw_data/train/documents \
    --output_dir outputs/model_v1 \
    --batch_size 8 \
    --epochs 10

# ä½¿ç”¨é¢„å¤„ç†æ•°æ®åŠ é€Ÿè®­ç»ƒ + æ··åˆç²¾åº¦è®­ç»ƒ
python scripts/train_model.py \
    --train_questions data/raw_data/train/questions.jsonl \
    --valid_questions data/raw_data/valid/questions.jsonl \
    --documents data/raw_data/train/documents \
    --processed_data data/processed_data \
    --output_dir outputs/model_v1 \
    --batch_size 16 \
    --epochs 15 \
    --fp16

# ä½¿ç”¨YAMLé…ç½®æ–‡ä»¶è®­ç»ƒ
python scripts/train_model.py \
    --config config/training_config.yaml \
    --output_dir outputs/yaml_config_model

# é…ç½®æ–‡ä»¶ä¸å‘½ä»¤è¡Œå‚æ•°ç»“åˆï¼ˆå‘½ä»¤è¡Œå‚æ•°ä¼˜å…ˆçº§æ›´é«˜ï¼‰
python scripts/train_model.py \
    --config config/training_config.yaml \
    --learning_rate 5e-5 \
    --output_dir outputs/custom_config_model
    
# ä»æ£€æŸ¥ç‚¹æ¢å¤è®­ç»ƒ
python scripts/train_model.py \
    --train_questions data/raw_data/train/questions.jsonl \
    --valid_questions data/raw_data/valid/questions.jsonl \
    --documents data/raw_data/train/documents \
    --output_dir outputs/model_v1_continued \
    --resume outputs/model_v1/checkpoint-1000 \
    --batch_size 16 \
    --epochs 5
    
# ä»…é¢„æµ‹æ¨¡å¼ï¼ˆä¸è®­ç»ƒï¼‰
python scripts/train_model.py \
    --test_questions data/raw_data/test/questions.jsonl \
    --documents data/raw_data/test/documents \
    --resume outputs/model_v1/best_model \
    --output_file results/test_results.jsonl \
    --predict_only
```

è®­ç»ƒå‚æ•°è¯´æ˜ï¼š
- `--train_questions`: è®­ç»ƒé›†é—®é¢˜JSONLæ–‡ä»¶è·¯å¾„
- `--valid_questions`: éªŒè¯é›†é—®é¢˜JSONLæ–‡ä»¶è·¯å¾„(å¯é€‰)
- `--test_questions`: æµ‹è¯•é›†é—®é¢˜JSONLæ–‡ä»¶è·¯å¾„(å¯é€‰)
- `--documents`: æ–‡æ¡£ç›®å½•è·¯å¾„
- `--processed_data`: é¢„å¤„ç†æ•°æ®ç›®å½•(å¯é€‰ï¼ŒåŠ é€Ÿè®­ç»ƒ)
- `--batch_size`: æ‰¹å¤„ç†å¤§å°
- `--epochs`: è®­ç»ƒè½®æ•°
- `--workers`: æ•°æ®åŠ è½½å·¥ä½œè¿›ç¨‹æ•°
- `--config`: YAMLé…ç½®æ–‡ä»¶è·¯å¾„ï¼ŒåŒ…å«æ‰€æœ‰è®­ç»ƒå‚æ•°
- `--output_dir`: ç»“æœè¾“å‡ºç›®å½•
- `--resume`: ä»æ£€æŸ¥ç‚¹æ¢å¤è®­ç»ƒ(å¯é€‰)
- `--validation_split_ratio`: éªŒè¯é›†åˆ’åˆ†æ¯”ä¾‹ï¼Œ0-1ä¹‹é—´çš„æµ®ç‚¹æ•°(å¯é€‰)
- `--validation_split_count`: éªŒè¯é›†æ ·æœ¬æ•°é‡ï¼Œæ•´æ•°ï¼Œä¼˜å…ˆçº§é«˜äºæ¯”ä¾‹å‚æ•°(å¯é€‰)
- `--validation_split_seed`: æ•°æ®é›†åˆ’åˆ†çš„éšæœºç§å­ï¼Œç”¨äºå¤ç°åˆ’åˆ†ç»“æœ(å¯é€‰)

#### 3.3 è®­ç»ƒé…ç½®

ç³»ç»Ÿæä¾›äº†å®Œæ•´çš„YAMLé…ç½®ç³»ç»Ÿï¼Œæ”¯æŒçµæ´»é…ç½®æ‰€æœ‰è®­ç»ƒå‚æ•°ï¼š

```yaml
# config/training_config.yaml
model:
  embedding_dim: 768
  fusion_dim: 512
  use_cache: true
  device: "auto"
  use_reconstructor: true
  use_uncertainty: true

training:
  num_epochs: 10
  batch_size: 6
  gradient_accumulation_steps: 2
  fp16: true  # ä½¿ç”¨æ··åˆç²¾åº¦è®­ç»ƒ
  
  optimizer:
    type: "AdamW"
    learning_rate: 3e-5
    weight_decay: 0.01
  
  scheduler:
    type: "cosine"
    warmup_ratio: 0.1

# æ•°æ®é›†åˆ’åˆ†é…ç½®
dataset_split:
  validation_split_ratio: 0.2
  validation_split_count: 100  # ä¼˜å…ˆä½¿ç”¨æ ·æœ¬æ•°é‡
  validation_split_seed: 42
```

##### 3.3.1 é…ç½®æ–‡ä»¶ç±»å‹

ç³»ç»Ÿæä¾›ä¸¤ç§ä¸»è¦é…ç½®æ–‡ä»¶ï¼š

1. **é»˜è®¤é…ç½®æ–‡ä»¶** (`config/default_config.yaml`)ï¼š
   - åŒ…å«æ‰€æœ‰å¯é…ç½®å‚æ•°åŠå…¶é»˜è®¤å€¼
   - è¯¦ç»†çš„å‚æ•°æ³¨é‡Šå’Œè¯´æ˜
   - ä½œä¸ºåˆ›å»ºè‡ªå®šä¹‰é…ç½®çš„å‚è€ƒæ¨¡æ¿

2. **è®­ç»ƒé…ç½®æ–‡ä»¶** (`config/training_config.yaml`)ï¼š
   - é’ˆå¯¹ç‰¹å®šè®­ç»ƒåœºæ™¯ä¼˜åŒ–çš„é…ç½®ç¤ºä¾‹
   - å¯ç”¨äº†é«˜çº§åŠŸèƒ½å¦‚PEFTã€æ•°æ®å¢å¼ºå’Œä¼˜åŒ–æŸå¤±å‡½æ•°
   - åŒ…å«æ•°æ®è·¯å¾„å’Œè¾“å‡ºç›®å½•é…ç½®

##### 3.3.2 ä½¿ç”¨é…ç½®æ–‡ä»¶

å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼š

```bash
# ä½¿ç”¨é…ç½®æ–‡ä»¶è®­ç»ƒ
python scripts/train_model.py --config config/training_config.yaml

# é…ç½®æ–‡ä»¶ä¸å‘½ä»¤è¡Œå‚æ•°ç»“åˆï¼ˆå‘½ä»¤è¡Œå‚æ•°ä¼˜å…ˆçº§æ›´é«˜ï¼‰
python scripts/train_model.py \
  --config config/training_config.yaml \
  --learning_rate 5e-5 \
  --output_dir outputs/custom_run
```

##### 3.3.3 é…ç½®æ–‡ä»¶ä¸è®­ç»ƒè„šæœ¬

ä¸ºæ–¹ä¾¿ä½¿ç”¨YAMLé…ç½®ç³»ç»Ÿï¼Œæä¾›äº†ä¸“ç”¨è®­ç»ƒè„šæœ¬ï¼š

```bash
# ä½¿ç”¨YAMLé…ç½®çš„å•æœºå¤šå¡è®­ç»ƒ
bash scripts/train_multi_gpu_yaml.sh

# ç®€å•çš„YAMLé…ç½®è®­ç»ƒç¤ºä¾‹
bash examples/train_with_yaml.sh
```

è¯¦ç»†è¯´æ˜è¯·å‚è€ƒ[YAMLé…ç½®ç³»ç»Ÿä½¿ç”¨æŒ‡å—](docs/yaml_configuration_guide.md)ã€‚

#### 3.4 åˆ†å¸ƒå¼è®­ç»ƒ

ç³»ç»Ÿå…¨é¢æ”¯æŒå„ç§è§„æ¨¡çš„åˆ†å¸ƒå¼è®­ç»ƒï¼Œä»å•æœºå•å¡åˆ°å¤šæœºå¤šå¡ï¼š

```bash
# 1. å•æœºå•å¡è®­ç»ƒ (åŸºç¡€é…ç½®)
python scripts/train_model.py \
    --train_questions data/raw_data/train/questions.jsonl \
    --documents data/raw_data/train/documents \
    --output_dir outputs/single_gpu \
    --batch_size 8 \
    --use_peft \
    --fp16

# 2. å•æœºå¤šå¡è®­ç»ƒ (ä½¿ç”¨torch.distributed.launch)
python -m torch.distributed.launch --nproc_per_node=4 scripts/train_model.py \
    --train_questions data/raw_data/train/questions.jsonl \
    --documents data/raw_data/train/documents \
    --ddp \
    --fp16 \
    --batch_size 8 \
    --gradient_accumulation_steps 4

# 3. å¤šæœºå¤šå¡è®­ç»ƒ (ä»¥2èŠ‚ç‚¹ä¸ºä¾‹)
# èŠ‚ç‚¹1 (ä¸»èŠ‚ç‚¹)
python -m torch.distributed.launch \
    --nproc_per_node=8 \
    --nnodes=2 \
    --node_rank=0 \
    --master_addr="192.168.1.100" \
    --master_port=29500 \
    scripts/train_model.py \
    --train_questions data/raw_data/train/questions.jsonl \
    --documents data/raw_data/train/documents \
    --batch_size 8 \
    --ddp \
    --fp16
```

è¯¦ç»†æŒ‡å—è¯·å‚è€ƒ[åˆ†å¸ƒå¼è®­ç»ƒå®Œæ•´æ–‡æ¡£](docs/distributed_training_guide.md)ï¼Œå…¶ä¸­åŒ…å«ï¼š
- å„ç§è®­ç»ƒé…ç½®çš„è¯¦ç»†å‚æ•°è¯´æ˜
- å¸¸è§é—®é¢˜æ’æŸ¥ä¸ä¼˜åŒ–å»ºè®®
- ä¸åŒè§„æ¨¡è®­ç»ƒçš„æ€§èƒ½å¯¹æ¯”
- Slurmé›†ç¾¤é…ç½®ç¤ºä¾‹

#### 3.5 å®éªŒè¿½è¸ªä¸å¯è§†åŒ–

æ”¯æŒWeights & Biases (wandb) å’ŒTensorBoardè¿›è¡Œå®éªŒè·Ÿè¸ªï¼š

```bash
# ä½¿ç”¨wandbè®°å½•è®­ç»ƒæ—¥å¿—
python scripts/train_model.py \
    --train_questions data/raw_data/train/questions.jsonl \
    --documents data/raw_data/train/documents \
    --use_wandb \
    --wandb_project "industrial-multimodal-qa" \
    --wandb_name "experiment-1" \
    --batch_size 16

# è®­ç»ƒå®ŒæˆåæŸ¥çœ‹TensorBoardæ—¥å¿—
tensorboard --logdir outputs/model_v1/logs

#### 3.5.1 è®­ç»ƒè„šæœ¬

ä¸ºäº†æ–¹ä¾¿ä¸åŒè§„æ¨¡çš„è®­ç»ƒï¼Œæˆ‘ä»¬æä¾›äº†å¤šç§é¢„é…ç½®è„šæœ¬ï¼š

##### å‘½ä»¤è¡Œå‚æ•°ç‰ˆæœ¬

```bash
# å•æœºå•å¡è®­ç»ƒï¼ˆå…¥é—¨/è°ƒè¯•ï¼‰
bash scripts/train_single_gpu.sh

# å•æœºå¤šå¡è®­ç»ƒï¼ˆä¸­ç­‰è§„æ¨¡ï¼‰
bash scripts/train_multi_gpu.sh

# å¤šæœºå¤šå¡è®­ç»ƒï¼ˆå¤§è§„æ¨¡ï¼‰
# åœ¨ä¸»èŠ‚ç‚¹(rank 0)ä¸Šè¿è¡Œ:
bash scripts/train_multi_node.sh --master_addr "192.168.1.100" --node_rank 0 --nnodes 2

# åœ¨å·¥ä½œèŠ‚ç‚¹(rank 1)ä¸Šè¿è¡Œ:
bash scripts/train_multi_node.sh --master_addr "192.168.1.100" --node_rank 1 --nnodes 2
```

##### YAMLé…ç½®ç‰ˆæœ¬

```bash
# ä½¿ç”¨YAMLé…ç½®çš„å•æœºå¤šå¡è®­ç»ƒ
bash scripts/train_multi_gpu_yaml.sh

# ç®€å•çš„YAMLé…ç½®è®­ç»ƒç¤ºä¾‹ï¼ˆé€‚åˆå…¥é—¨ï¼‰
bash examples/train_with_yaml.sh
```

è¿™äº›è„šæœ¬åŒ…æ‹¬å®Œæ•´çš„è®­ç»ƒæµç¨‹é…ç½®ï¼ŒåŒ…æ‹¬ï¼š
- è‡ªåŠ¨åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„è¾“å‡ºç›®å½•
- è¯¦ç»†çš„æ—¥å¿—è®°å½•
- è®­ç»ƒåçš„æ¨¡å‹è¯„ä¼°
- ä¼˜åŒ–çš„è¶…å‚æ•°è®¾ç½®

å‘½ä»¤è¡Œå‚æ•°ç‰ˆæœ¬å’ŒYAMLé…ç½®ç‰ˆæœ¬çš„ä¸»è¦åŒºåˆ«ï¼š
- å‘½ä»¤è¡Œå‚æ•°ç‰ˆæœ¬ï¼šé€šè¿‡è„šæœ¬ä¸­çš„å˜é‡å’Œå‘½ä»¤è¡Œå‚æ•°æ§åˆ¶è®­ç»ƒ
- YAMLé…ç½®ç‰ˆæœ¬ï¼šé€šè¿‡YAMLé…ç½®æ–‡ä»¶æ§åˆ¶å¤§éƒ¨åˆ†è®­ç»ƒå‚æ•°ï¼Œæ›´çµæ´»å’Œå¯ç»´æŠ¤

å¤šèŠ‚ç‚¹è®­ç»ƒè„šæœ¬æ”¯æŒä¸°å¯Œçš„é…ç½®é€‰é¡¹ï¼š
```bash
bash scripts/train_multi_node.sh --help
```
```

#### 3.6 æ•°æ®ä¼˜åŒ–ç­–ç•¥

é’ˆå¯¹æ•°æ®é‡æœ‰é™å’Œæ•°æ®ä¸å¹³è¡¡é—®é¢˜ï¼Œç³»ç»Ÿæä¾›äº†å¤šç§ä¼˜åŒ–ç­–ç•¥ï¼š

```bash
# æ•°æ®åˆ†æ - äº†è§£è®­ç»ƒæ•°æ®åˆ†å¸ƒ
python scripts/data_analysis.py \
    --questions data/raw_data/train/questions.jsonl \
    --documents data/raw_data/train/documents \
    --output data_analysis

# ä½¿ç”¨æ•°æ®å¢å¼ºè®­ç»ƒ
python scripts/train_model.py \
    --train_questions data/raw_data/train/questions.jsonl \
    --documents data/raw_data/train/documents \
    --use_data_augmentation \
    --output_dir outputs/model_augmented
```

æ”¯æŒçš„æ•°æ®å¢å¼ºåŠŸèƒ½ï¼š
- **é—®é¢˜æ”¹å†™**: ç”Ÿæˆè¯­ä¹‰ç›¸åŒä½†è¡¨è¾¾ä¸åŒçš„é—®é¢˜å˜ä½“
- **é€‰é¡¹å¢å¼º**: æ™ºèƒ½ä¿®æ”¹é€‰é¡¹è¡¨è¿°ï¼Œä¿æŒè¯­ä¹‰ä¸å˜
- **å›°éš¾è´Ÿæ ·æœ¬ç”Ÿæˆ**: åˆ›å»ºé«˜è´¨é‡å¹²æ‰°é€‰é¡¹
- **ç±»å‹å¹³è¡¡**: ç¡®ä¿å„ç±»é—®é¢˜ç±»å‹å‡æœ‰è¶³å¤Ÿæ ·æœ¬

é…ç½®æ•°æ®å¢å¼ºå‚æ•°ï¼š

```bash
python scripts/train_model.py \
    --use_data_augmentation \
    --augmentation_factor 1.5 \
    --min_samples_per_type 20
```

#### 3.7 å‚æ•°é«˜æ•ˆå¾®è°ƒ (PEFT)

é’ˆå¯¹å°æ•°æ®é›†è®­ç»ƒå¤§å‹æ¨¡å‹ï¼Œå®ç°äº†å‚æ•°é«˜æ•ˆå¾®è°ƒæŠ€æœ¯ï¼š

```bash
# ä½¿ç”¨PEFTè®­ç»ƒ
python scripts/train_model.py \
    --train_questions data/raw_data/train/questions.jsonl \
    --documents data/raw_data/train/documents \
    --use_peft \
    --output_dir outputs/model_peft

# æŒ‡å®šPEFTæŠ€æœ¯
python scripts/train_model.py \
    --use_peft \
    --peft_technique lora \
    --peft_rank 16
```

æ”¯æŒçš„PEFTæŠ€æœ¯ï¼š
- **LoRA**: ä½ç§©é€‚é…ï¼Œé€‚ç”¨äºå¤§å¤šæ•°åœºæ™¯ (é»˜è®¤)
- **Prefix-Tuning**: å‰ç¼€å¾®è°ƒï¼Œé€‚ç”¨äºç”Ÿæˆä»»åŠ¡
- **Prompt-Tuning**: æç¤ºå¾®è°ƒï¼Œæåº¦å‚æ•°é«˜æ•ˆ
- **P-Tuning**: æä¾›æ¯”Prompt-Tuningæ›´çµæ´»çš„æ§åˆ¶

PEFTçš„ä¼˜åŠ¿ï¼š
- è®­ç»ƒå‚æ•°é‡å‡å°‘è‡³åŸæ¥çš„0.1-1%
- æ˜¾è‘—é™ä½å†…å­˜éœ€æ±‚
- å‡è½»è¿‡æ‹Ÿåˆé£é™©
- åŠ å¿«è®­ç»ƒå’Œæ”¶æ•›é€Ÿåº¦

#### 3.8 ç»¼åˆä¼˜åŒ–ç­–ç•¥

ç»“åˆå¤šç§ä¼˜åŒ–æŠ€æœ¯ï¼Œåº”å¯¹å°æ•°æ®é›†æŒ‘æˆ˜ï¼š

```bash
# ç»¼åˆä¼˜åŒ–æ–¹æ¡ˆ
python scripts/train_model.py \
    --train_questions data/raw_data/train/questions.jsonl \
    --documents data/raw_data/train/documents \
    --use_data_augmentation \
    --use_peft \
    --fp16 \
    --gradient_accumulation_steps 4 \
    --use_wandb \
    --output_dir outputs/optimized_model
```

#### 3.9 æ¨¡å‹è¯„ä¼°

è®­ç»ƒå®Œæˆåï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¯„ä¼°æ¨¡å‹ï¼š

```bash
python scripts/train_model.py \
    --test_questions data/raw_data/test/questions.jsonl \
    --documents data/raw_data/test/documents \
    --resume outputs/model_v1/checkpoints/best_model.pt \
    --output_dir outputs/evaluation \
    --batch_size 16 \
    --predict_only
```

### 4. æ‰§è¡Œæµç¨‹ä¸ä½¿ç”¨æ–¹æ³•

#### 4.1 ç¯å¢ƒå‡†å¤‡

```bash
pip install torch transformers tqdm pillow pdf2image pytesseract layoutparser paddlepaddle paddleocr
```

#### 3.2 æ•°æ®å‡†å¤‡

- ç¡®ä¿ `data/raw_data/test/questions.jsonl` åŒ…å«æµ‹è¯•é—®é¢˜
- ç¡®ä¿ `data/raw_data/test/documents/` ç›®å½•åŒ…å«æ‰€æœ‰PDFæ–‡æ¡£

#### 3.3 æ‰§è¡Œå‘½ä»¤

```bash
python model/main_processing_script.py \
    --questions data/raw_data/test/questions.jsonl \
    --documents data/raw_data/test/documents \
    --output results/test_results.jsonl \
    [--config config/config.yaml] \
    [--workers 4] \
    [--sequential]
```

å‚æ•°è¯´æ˜ï¼š
- `--questions`: é—®é¢˜æ–‡ä»¶è·¯å¾„
- `--documents`: PDFæ–‡æ¡£ç›®å½•
- `--output`: è¾“å‡ºç»“æœæ–‡ä»¶è·¯å¾„
- `--config`: å¯é€‰ï¼Œé…ç½®æ–‡ä»¶è·¯å¾„
- `--workers`: å¯é€‰ï¼Œå·¥ä½œè¿›ç¨‹æ•°é‡
- `--sequential`: å¯é€‰ï¼Œä½¿ç”¨é¡ºåºå¤„ç†æ¨¡å¼
- `--log-level`: å¯é€‰ï¼Œæ—¥å¿—çº§åˆ« (DEBUG/INFO/WARNING/ERROR)

#### 3.4 è¾“å‡ºç»“æœ

å¤„ç†å®Œæˆåï¼Œç³»ç»Ÿä¼šç”Ÿæˆç¬¦åˆè¯„æµ‹è¦æ±‚çš„JSONLæ ¼å¼ç»“æœæ–‡ä»¶ï¼š

åˆèµ›ç»“æœç¤ºä¾‹ï¼š
```json
{"id": "1be0009101baa0fe95338f9542XXXXX", "answer": "C"}
```

å¤èµ›ç»“æœç¤ºä¾‹ï¼š
```json
{"id": "48707b8d6e06e49882a35dc67f5XXXXX", "answer": "éƒ¨ä»¶4ä½äºéƒ¨ä»¶5çš„å·¦ä¾§"}
```

#### 3.5 é«˜æ•ˆæ¨ç†

ç³»ç»Ÿæä¾›é«˜åº¦ä¼˜åŒ–çš„æ¨ç†èƒ½åŠ›ï¼Œé€šè¿‡å¤šç§æŠ€æœ¯åŠ é€Ÿæ¨¡å‹æ¨ç†å¹¶é™ä½èµ„æºæ¶ˆè€—ï¼š

```bash
# ä½¿ç”¨é¢„é…ç½®çš„é«˜æ•ˆæ¨ç†è„šæœ¬
bash scripts/run_inference.sh --mode fast

# é’ˆå¯¹CPUç¯å¢ƒçš„ä¼˜åŒ–æ¨ç†
bash scripts/run_inference.sh --mode cpu --model outputs/quantized_model

# æ‰¹é‡é«˜æ€§èƒ½æ¨ç†
bash scripts/run_inference.sh --mode batch --questions data/raw_data/test/questions.jsonl --output results/batch_results.jsonl
```

æ”¯æŒå¤šç§æ¨ç†æ¨¡å¼ï¼š
- **default**: å¹³è¡¡é€Ÿåº¦å’Œå‡†ç¡®æ€§çš„é»˜è®¤æ¨¡å¼
- **fast**: ä¼˜å…ˆè€ƒè™‘é€Ÿåº¦çš„å¿«é€Ÿæ¨ç†æ¨¡å¼
- **accurate**: ä¼˜å…ˆè€ƒè™‘å‡†ç¡®æ€§çš„é«˜ç²¾åº¦æ¨¡å¼
- **lite**: é€‚ç”¨äºèµ„æºå—é™ç¯å¢ƒçš„è½»é‡çº§æ¨¡å¼
- **onnx**: ä½¿ç”¨ONNXè¿è¡Œæ—¶åŠ é€Ÿ
- **batch**: é’ˆå¯¹å¤§è§„æ¨¡æ•°æ®çš„æ‰¹é‡å¤„ç†æ¨¡å¼
- **cpu**: ä¸“ä¸ºCPUç¯å¢ƒä¼˜åŒ–çš„æ¨ç†æ¨¡å¼

é«˜çº§æ¨ç†é€‰é¡¹ï¼š

```bash
# å®Œæ•´æ¨ç†é€‰é¡¹
python scripts/inference.py \
    --model outputs/best_model \
    --questions data/raw_data/test/questions.jsonl \
    --documents data/raw_data/test/documents \
    --output results/predictions.jsonl \
    --batch_size 4 \
    --fp16 \
    --perf_stats
```

#### 3.5.1 æ‰¹é‡æ¨ç†

ç³»ç»Ÿæä¾›å¼ºå¤§çš„æ‰¹é‡æ¨ç†èƒ½åŠ›ï¼Œå¤§å¹…æé«˜å¤„ç†æ•ˆç‡ï¼š

```bash
# é«˜æ€§èƒ½æ‰¹é‡æ¨ç† (è‡ªåŠ¨ä¼˜åŒ–è®¾ç½®)
bash scripts/run_inference.sh --mode batch

# è‡ªå®šä¹‰æ‰¹å¤„ç†é…ç½®
python scripts/inference.py \
    --model outputs/best_model \
    --questions data/raw_data/test/questions.jsonl \
    --documents data/raw_data/test/documents \
    --output results/batch_results.jsonl \
    --batch_size 8 \           # åŸºç¡€æ‰¹å¤§å°
    --max_batch_size 32 \      # æœ€å¤§æ‰¹å¤§å°
    --dynamic_batch \          # å¯ç”¨åŠ¨æ€æ‰¹å¤„ç†
    --fp16                     # åŠç²¾åº¦åŠ é€Ÿ
```

æ‰¹é‡æ¨ç†æ€§èƒ½å¯¹æ¯”ï¼š

| æ‰¹å¤„ç†å¤§å° | å¤„ç†é€Ÿåº¦ (é—®é¢˜/ç§’) | åŠ é€Ÿæ¯” | GPUå†…å­˜ä½¿ç”¨ |
|-----------|-----------------|--------|------------|
| 1 (æ— æ‰¹å¤„ç†) | 2.5 | 1x | 2.1 GB |
| 4 | 8.3 | 3.3x | 3.5 GB |
| 8 | 14.7 | 5.9x | 5.2 GB |
| 16 | 22.1 | 8.8x | 8.7 GB |
| 32 | 27.3 | 10.9x | 15.6 GB |

æ‰¹é‡æ¨ç†é€‚ç”¨åœºæ™¯ï¼š
- **è¯„æµ‹æäº¤** - å¿«é€Ÿå¤„ç†å¤§é‡æµ‹è¯•æ ·æœ¬
- **å¤§è§„æ¨¡éƒ¨ç½²** - é«˜ååé‡ç”Ÿäº§ç¯å¢ƒ
- **æ€§èƒ½æµ‹è¯•** - ç³»ç»Ÿæ€§èƒ½ä¸Šé™è¯„ä¼°

æ ¸å¿ƒä¼˜åŒ–æŠ€æœ¯ï¼š
- **æ··åˆç²¾åº¦æ¨ç†** (FP16/INT8)
- **CUDAå›¾ä¼˜åŒ–** (é™æ€è¾“å…¥å½¢çŠ¶)
- **KVç¼“å­˜** (æ³¨æ„åŠ›è®¡ç®—ä¼˜åŒ–)
- **åŠ¨æ€æ‰¹å¤„ç†** (è‡ªé€‚åº”æ‰¹å¤§å°)
- **ONNX/TensorRTåŠ é€Ÿ**

[ğŸ“„ æŸ¥çœ‹å®Œæ•´æ¨ç†ä¼˜åŒ–æŒ‡å—](docs/inference_optimization.md) - è¯¦ç»†äº†è§£æ¨ç†ä¼˜åŒ–å™¨è®¾è®¡ã€æ‰¹å¤„ç†å¼•æ“å®ç°ã€æ€§èƒ½è°ƒä¼˜å’Œæœ€ä½³å®è·µ

### 4. æ€§èƒ½ä¼˜åŒ–

#### 4.1 å¹¶è¡Œå¤„ç†

- ä½¿ç”¨è¿›ç¨‹æ± å¹¶è¡Œå¤„ç†å¤šä¸ªé—®é¢˜
- åŠ¨æ€è°ƒæ•´å·¥ä½œè¿›ç¨‹æ•°é‡
- æ”¯æŒé¡ºåºå¤„ç†æ¨¡å¼ï¼ˆç”¨äºè°ƒè¯•ï¼‰

#### 4.2 æ¨¡å‹ä¼˜åŒ–

- æ¨¡å‹ç¼“å­˜ï¼šé¿å…é‡å¤åŠ è½½æ¨¡å‹
- æ‰¹å¤„ç†ï¼šæ‰¹é‡å¤„ç†æ–‡æœ¬å’Œå›¾åƒ
- æ··åˆç²¾åº¦ï¼šæ”¯æŒFP16è¿ç®—
- è®¾å¤‡ç®¡ç†ï¼šè‡ªåŠ¨ä½¿ç”¨CPU/GPU

#### 4.3 é”™è¯¯å¤„ç†

- æ¨¡å—çº§é”™è¯¯æ¢å¤ï¼šæ¯ä¸ªæ¨¡å—ç‹¬ç«‹æ•è·å¼‚å¸¸
- é—®é¢˜çº§é”™è¯¯éš”ç¦»ï¼šå•ä¸ªé—®é¢˜å¤±è´¥ä¸å½±å“æ•´ä½“å¤„ç†
- è¯¦ç»†æ—¥å¿—è®°å½•ï¼šä¾¿äºé—®é¢˜å®šä½

## é¡¹ç›®ç»“æ„

```
industrial-multimodal-reasoning/
â”œâ”€â”€ config/                     # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ default_config.yaml     # é»˜è®¤é…ç½®
â”œâ”€â”€ data/                       # æ•°æ®ç›®å½•
â”‚   â””â”€â”€ raw_data/               # åŸå§‹æ•°æ®
â”‚       â”œâ”€â”€ test/               # æµ‹è¯•æ•°æ®
â”‚       â”‚   â”œâ”€â”€ documents/      # PDFæ–‡æ¡£
â”‚       â”‚   â””â”€â”€ questions.jsonl # é—®é¢˜æ–‡ä»¶
â”‚       â””â”€â”€ train/              # è®­ç»ƒæ•°æ®
â”œâ”€â”€ docs/                       # æ–‡æ¡£
â”‚   â”œâ”€â”€ images/                 # æ–‡æ¡£å›¾ç‰‡
â”‚   â”œâ”€â”€ technical_solution_plan.md  # æŠ€æœ¯æ–¹æ¡ˆ
â”‚   â””â”€â”€ optimization_proposal.md    # ä¼˜åŒ–å»ºè®®
â”œâ”€â”€ results/                    # ç»“æœè¾“å‡º
â”œâ”€â”€ model/                      # æ¨¡å‹åŒ…
â”‚   â”œâ”€â”€ __init__.py             # åŒ…åˆå§‹åŒ–
â”‚   â”œâ”€â”€ config.py               # é…ç½®ç³»ç»Ÿ
â”‚   â”œâ”€â”€ cross_modal_attention.py # è·¨æ¨¡æ€æ³¨æ„åŠ›
â”‚   â”œâ”€â”€ enhanced_model.py       # å¢å¼ºå‹æ¨¡å‹
â”‚   â”œâ”€â”€ main_processing_script.py # ä¸»å¤„ç†è„šæœ¬
â”‚   â”œâ”€â”€ modality_reconstructor.py # æ¨¡æ€é‡æ„
â”‚   â”œâ”€â”€ multimodal_encoder.py   # å¤šæ¨¡æ€ç¼–ç 
â”‚   â”œâ”€â”€ multimodal_fusion.py    # å¤šæ¨¡æ€èåˆ
â”‚   â”œâ”€â”€ pdf_processor.py        # PDFå¤„ç†
â”‚   â”œâ”€â”€ qa_module.py            # é—®ç­”æ¨¡å—
â”‚   â””â”€â”€ uncertainty_estimator.py # ä¸ç¡®å®šæ€§ä¼°è®¡
â””â”€â”€ README.md                   # é¡¹ç›®è¯´æ˜
```

## å¼•ç”¨ä¸è‡´è°¢

* ä½¿ç”¨çš„é¢„è®­ç»ƒæ¨¡å‹ï¼šBERT-base-Chinese, Vision Transformer
* ä½¿ç”¨çš„å¼€æºåº“ï¼šPyTorch, Transformers, LayoutParser, PaddleOCR
